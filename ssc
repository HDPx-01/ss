-- Fungsi untuk menjalankan perintah shell menggunakan os.execute
local function runCommand(command)
    local result = os.execute(command)
    return result
end

-- Fungsi untuk memutuskan koneksi ADB
local function disconnectADB()
    print("Memutus koneksi ADB...")
    local result = runCommand("adb disconnect")
    print(result)
end

-- Fungsi untuk menghubungkan ADB menggunakan IP
local function connectADB(ipAddress)
    print("Menghubungkan ke perangkat dengan IP: " .. ipAddress)
    local command = "adb connect " .. ipAddress
    local result = runCommand(command)
    print(result)
end

-- Fungsi untuk mendeteksi perangkat yang terhubung melalui jaringan
local function detectDeviceIP()
    print("Mendeteksi perangkat ADB yang terhubung di jaringan...")
    local result = os.execute("adb devices")
    if result == 0 then
        -- Kamu bisa mengecek hasilnya secara manual atau melalui log
        print("Perangkat ditemukan.")
        return true
    else
        print("Tidak ada perangkat ADB yang terhubung.")
        return nil
    end
end

-- Fungsi untuk mengambil screenshot
local function takeScreenshot(outputPath)
    print("Mengambil screenshot...")
    local command = "adb exec-out screencap -p > " .. outputPath
    local result = runCommand(command)
    if result == 0 then
        print("Screenshot berhasil disimpan di " .. outputPath)
    else
        print("Gagal mengambil screenshot. Pesan: " .. result)
    end
end

-- Proses Deteksi dan Penghubungan
disconnectADB()  -- Memutuskan koneksi ADB terlebih dahulu

local deviceIP = detectDeviceIP()  -- Mendeteksi perangkat dan IP
if deviceIP then
    connectADB(deviceIP)  -- Menghubungkan ke perangkat berdasarkan IP
    local outputPath = "screenshot.png"  -- Path untuk menyimpan screenshot
    takeScreenshot(outputPath)  -- Mengambil screenshot
else
    print("Proses gagal. Tidak ada perangkat yang terdeteksi.")
end
